<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>UPI Scanner & Web-Link Pay</title>
  <!-- jsQR for QR decoding -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 1rem; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; }
    #controls { margin-top: 1rem; }
    input, button, a { display: block; margin: .5rem auto; padding: .5rem 1rem; border-radius: 4px; border: 1px solid #888; text-decoration: none; }
    button { cursor: pointer; }
    a.whatsapp { background: #25D366; color: white; }
    a.paylink { background: #4CAF50; color: white; }
  </style>
</head>
<body>

  <!-- Redirect UI (shown only when pa & am present) -->
  <div id="redirectUI" hidden>
    <h1>Redirecting to UPI…</h1>
    <p id="redirMsg">If you’re not redirected, <a id="fallback" href="#">click here</a>.</p>
  </div>

  <!-- Scanner UI (default) -->
  <div id="scannerUI" hidden>
    <h1>UPI QR Scanner & Pay-Link Generator</h1>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" hidden></canvas>
    <div id="controls" hidden>
      <p>UPI ID: <strong><span id="upiId"></span></strong></p>
      <input id="amount" type="number" placeholder="Enter amount (INR)" min="1" step="0.01">
      <button id="generateLink">Generate Web-Link</button>
      <a id="payLink" class="paylink" href="#" target="_blank" hidden>Open Pay Link</a>
      <a id="whatsappShare" class="whatsapp" href="#" target="_blank" hidden>Share via WhatsApp</a>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const pa = params.get('pa');
    const am = params.get('am');

    if (pa && am) {
      // REDIRECT MODE: use Android intent:// scheme for chooser across all UPI apps
      document.getElementById('redirectUI').hidden = false;
      const intentLink =
        `intent://pay?pa=${encodeURIComponent(pa)}&am=${encodeURIComponent(am)}&cu=INR` +
        `#Intent;scheme=upi;action=android.intent.action.VIEW;end`;
      // fallback to basic UPI URI
      const upiUri = `upi://pay?pa=${encodeURIComponent(pa)}&am=${encodeURIComponent(am)}&cu=INR`;
      const fallbackEl = document.getElementById('fallback');
      fallbackEl.href = intentLink;
      fallbackEl.onclick = e => {
        // if intent fails, try the generic UPI URI
        setTimeout(() => window.location.replace(upiUri), 500);
      };
      // auto-redirect to intent URI
      setTimeout(() => window.location.replace(intentLink), 300);
    } else {
      // SCANNER MODE
      document.getElementById('scannerUI').hidden = false;
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const controls = document.getElementById('controls');
      const upiIdSpan = document.getElementById('upiId');
      const amountInput = document.getElementById('amount');
      const genBtn = document.getElementById('generateLink');
      const payLink = document.getElementById('payLink');
      const whatsappBtn = document.getElementById('whatsappShare');

      let scanning = true;

      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          requestAnimationFrame(tick);
        })
        .catch(err => alert('Error accessing camera: ' + err.message));

      function tick() {
        if (!scanning) return;
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(img.data, img.width, img.height);
          if (code?.data) {
            scanning = false;
            let upiId = code.data;
            if (upiId.toLowerCase().startsWith('upi://')) {
              try {
                const u = new URL(upiId);
                upiId = u.searchParams.get('pa') || upiId;
              } catch {};
            }
            upiIdSpan.textContent = upiId;
            controls.hidden = false;
          }
        }
        requestAnimationFrame(tick);
      }

      genBtn.addEventListener('click', () => {
        const upiId = upiIdSpan.textContent.trim();
        const amount = amountInput.value.trim();
        if (!upiId || !amount) return alert('Please enter both UPI ID and amount');
        // shareable HTTPS web-link pointing back here
        const webLink = `${location.origin + location.pathname}?pa=${encodeURIComponent(upiId)}&am=${encodeURIComponent(amount)}`;
        payLink.href = webLink;
        payLink.hidden = false;
        const msg = `Please pay ₹${amount} to ${upiId} via UPI:\n${webLink}`;
        whatsappBtn.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        whatsappBtn.hidden = false;
      });
    }
  </script>

</body>
</html>
